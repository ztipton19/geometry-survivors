<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Excalidraw Auto Viewer</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #container { width: 100vw; height: 100vh; }
    #file-list {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 300px;
    }
    #file-list select {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
    }
    #reload-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,128,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="file-list">
    <strong>Excalidraw Files:</strong>
    <select id="file-selector" onchange="loadSelectedFile()">
      <option>Loading files...</option>
    </select>
  </div>
  <div id="reload-info">Auto-refresh: ON (5s)</div>
  <div id="container"></div>

  <script type="module">
    import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.17.0";
    import React from "https://esm.sh/react@18";
    import ReactDOM from "https://esm.sh/react-dom@18";

    let currentFile = null;
    let excalidrawAPI = null;

    // Initialize Excalidraw
    const root = ReactDOM.createRoot(document.getElementById('container'));
    root.render(
      React.createElement(Excalidraw, {
        excalidrawAPI: (api) => { excalidrawAPI = api; }
      })
    );

    // Function to scan for .excalidraw files
    async function scanFiles() {
      try {
        const response = await fetch('/files.json');
        const files = await response.json();
        
        const selector = document.getElementById('file-selector');
        selector.innerHTML = '';
        
        if (files.length === 0) {
          selector.innerHTML = '<option>No .excalidraw files found</option>';
          return;
        }

        files.forEach((file, index) => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          selector.appendChild(option);
        });

        // Auto-load the most recent file if none selected
        if (!currentFile && files.length > 0) {
          currentFile = files[files.length - 1];
          selector.value = currentFile;
          loadFile(currentFile);
        } else if (currentFile) {
          // Reload current file if it still exists
          if (files.includes(currentFile)) {
            loadFile(currentFile);
          }
        }
      } catch (error) {
        console.error('Error scanning files:', error);
      }
    }

    // Function to load a specific file
    async function loadFile(filename) {
      try {
        const response = await fetch('/' + filename);
        const data = await response.json();
        
        if (excalidrawAPI) {
          excalidrawAPI.updateScene({
            elements: data.elements || [],
            appState: data.appState || {}
          });
        }
      } catch (error) {
        console.error('Error loading file:', error);
      }
    }

    // Function called when user selects a file
    window.loadSelectedFile = function() {
      const selector = document.getElementById('file-selector');
      currentFile = selector.value;
      loadFile(currentFile);
    };

    // Auto-refresh every 5 seconds
    setInterval(scanFiles, 5000);
    scanFiles(); // Initial scan
  </script>
</body>
</html>
